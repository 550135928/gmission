<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Hits for Concepts of Table Head</title>
</head>
<style>
header {
    background-color: #23527c;
    color:white;
    text-align:center;
    padding:5px;
}
nav {
    line-height:30px;
    background-color:#eeeeee;
    height:300px;
    width:100px;
    float:left;
    padding:5px;
}
section {
    width: 70%;
    float:left;
    padding:10px;
}
aside {
    width: 30%;
    float:right;
    padding:10px;
}
footer {
    background-color:black;
    color:white;
    clear:both;
    text-align:center;
    padding:5px;
}
</style>
<script type="text/javascript" src="{{url_for('static',filename='js/jquery-2.1.1.min.js')}}"></script>
<script>
    var label_text_id_list = [];
    var goToNextHit = false;
{#    var projectName = "/gmission";#}
    var projectName = "";

    function submitAnswer(){
        var answer_content = '';
        if(!$("input[name='radio_id']:checked").val()) {$('#notification').text('Please choose the subject of the given table...');return;}
        answer_content += $("input[name='radio_id']:checked").val()+"$";


        for (var i = 0; i <label_text_id_list.length; i++) {
            if($("#" +label_text_id_list[i]).val().length == 0) {
                $('#notification').text('Please fill the concept about ' + label_text_id_list[i].substr(10));
                return;
            } else {
                answer_content += label_text_id_list[i].substr(10) +":"+ $("#" +label_text_id_list[i]+ "").val() +"#";
            }
        }


        var email_address = $('#email_address').val();
        var hit_number = $('#hit_number').val();

        $.ajax({
            type: 'POST',
            url:"http://"+window.location.host+projectName+"/table_head_answer_hit",
            data:{ hit_number: hit_number, answer_content: answer_content, email_address: email_address },
            success: function(msg){
                if(msg != 'OK'){
                    alert(msg);
                    $('#notification').text('Email Error... Please refresh this task to try again...');
                }
                if(goToNextHit){
                    $('#notification').text('Submission OK. Jumping to the next hit...');

                    var url = "http://"+window.location.host+projectName+"/table_head_hit/"+email_address+"/"+hit_number;
                    window.location = url;
                }


            },
            error: function(xhr, textStatus, errorThrown){
                $('#notification').text('Submission Failed! Please check you network or try later!');
            }
        });

    }

    function submitAndGoToNextHit(){
        goToNextHit = true;
        submitAnswer();
    }

    function jumpToNextHit(){
        var email_address = $('#email_address').val();
        var hit_number = $('#hit_number').val();
        var url = "http://"+window.location.host+projectName+"/jump_to_next_table_head_hit/"+email_address+"/"+hit_number;
        window.location = url;
    }

    $(document).ready(function() {
        var table_content_string = '{{ table_content }}';
        var table_content_rows = table_content_string.split("|");

        var table_string = "<table border='1'><tr>"
        var radio_option_string = "";

        for (var i = 0; i < table_content_rows.length; i++) {
            var table_columns = table_content_rows[i].split("#");

            if ( i == 0) {
                for ( var j = 0; j < table_columns.length; j++) {
                    radio_option_string += ' <input type="radio" name="radio_id" value='+ (j+1) +' >' + (j+1) + ' <br/>';
                    table_string += "<td>"+(j+1)+"</td>";
                }
                table_string += "</tr>";
                table_string += "<tr>"
            }
            for ( var j = 0; j < table_columns.length; j++) {
                table_string += "<td>"+table_columns[j]+"</td>";
            }
            table_string += "</tr>";
            if (i != table_content_rows.length - 1) {
                table_string += "<tr>"
            }
        }
        $('#insert_option_position').replaceWith(radio_option_string);
        $('#insert_table_position').replaceWith(table_string);
        var table_columns = table_content_rows[0].split("#");
        var label_string = "";
        for (var i = 1; i <= table_columns.length; i++){
            var label_text_id = 'label_text'+(i);
            label_text_id_list.push(label_text_id);
            label_string += i + ':<input type="text" id="' + label_text_id +'"> <br/>';
        }
        for (var i = 1; i <= table_columns.length; i++) {
            for (var j = i+1; j <= table_columns.length; j++) {
                var label_text_id = 'label_text'+i + 'and' + j;
                label_text_id_list.push(label_text_id);
                label_string += i + 'and' + j + ':<input type="text" id="' + label_text_id +'"> <br/>';
            }
        }
        $('#insert_label_position').replaceWith(label_string);

    })
</script>
<body>
<label for="email_address">Email:</label><input type="text" name="email_address" id="email_address" value="{{ email }}" disabled/>
<label for="credits">Credits:</label><input type="text" name="credits" id="credits" value="{{ credits }}" disabled/>
<br/>
<hr/>
<label for="hit_number">Hit Number:</label><input type="text" name="hit_number" id="hit_number" value="{{ hit_number }}" disabled/> <br/>
<font style="font-weight: bold;">Hit Value:</font> {{ hit_value }} <br/>
<font style="font-weight: bold;">Query:</font> Please select the subject column of the given table. Also, please label the concept of each column or the relationship between columns.<br/>
<div id="table" name="table">
    <br/>
    <b>Given Table:</b>
    <div id="insert_table_position" ></div><br/>
</div>


<div id="options" name="options">
    <b>Subject Column is:</b>
    <br/>
    <div id="insert_option_position" ></div><br/>
</div>

<div id="labels" name="labels">
    <b>Please Label the concepts below (If you have no idea about some concept, please fill "N" in the corresponding textbox.):</b>
    <br>
    <div id="insert_label_position" ></div><br/>
</div>

<hr>
<div id="notification" name="notification" style="color: red"></div>
{#<button style="margin-right: 5%" onclick="submitAnswer();">Submit</button>#}
<button style="margin-right: 5%" onclick="submitAndGoToNextHit();">Submit</button>
<button onclick="jumpToNextHit();">Skip</button>
</body>
</html>